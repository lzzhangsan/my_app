name: Build Stable APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Ensure assets directories exist
        run: |
          mkdir -p assets/media
          touch assets/media/.gitkeep

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Configure Android build environment
        run: |
          cd android
          
          # ç¡®ä¿ä½¿ç”¨Gradle 8.6ï¼ˆä½¿ç”¨è…¾è®¯äº‘é•œåƒåŠ é€Ÿï¼‰
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://mirrors.cloud.tencent.com/gradle/gradle-8.6-all.zip
networkTimeout=60000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
          
          # é…ç½®gradle.properties
          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          android.nonTransitiveRClass=false
          android.nonFinalResIds=false
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.caching=true
          org.gradle.configureondemand=false
          android.enableBuildCache=false
          EOF
          
          # ç¡®ä¿build.gradleä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬
          sed -i 's/com.android.tools.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.4.0/g' build.gradle
          
          # ç¡®ä¿settings.gradleä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬
          sed -i 's/id "com.android.application" version "[0-9.]\+"/id "com.android.application" version "8.4.0"/g' settings.gradle

      - name: Make gradlew executable
        run: |
          chmod +x android/gradlew

      - name: Verify Flutter setup
        run: |
          flutter doctor -v
          flutter --version
          cd android && ./gradlew --version

      - name: Clean and prepare
        run: |
          flutter clean
          flutter pub get

      - name: Build Debug APK
        run: |
          export GRADLE_OPTS="-Xmx4g -Dorg.gradle.jvmargs=-Xmx4g"
          export _JAVA_OPTIONS="-Xmx4g"
          flutter build apk --debug --verbose
        timeout-minutes: 30

      - name: Verify APK creation
        run: |
          echo "=== æŸ¥æ‰¾ç”Ÿæˆçš„APKæ–‡ä»¶ ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°APKæ–‡ä»¶"
          
          echo "\n=== æ£€æŸ¥è¾“å‡ºç›®å½• ==="
          ls -la build/app/outputs/flutter-apk/ 2>/dev/null || echo "flutter-apkç›®å½•ä¸å­˜åœ¨"
          ls -la build/app/outputs/apk/debug/ 2>/dev/null || echo "apk/debugç›®å½•ä¸å­˜åœ¨"
          
          # æ£€æŸ¥APKæ–‡ä»¶å¤§å°
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "âœ… APKæ„å»ºæˆåŠŸ:"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
            file build/app/outputs/flutter-apk/app-debug.apk
          elif [ -f "build/app/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… APKæ„å»ºæˆåŠŸï¼ˆå¤‡ç”¨è·¯å¾„ï¼‰:"
            ls -lh build/app/outputs/apk/debug/app-debug.apk
            file build/app/outputs/apk/debug/app-debug.apk
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: my-app-debug-apk
          path: |
            build/app/outputs/flutter-apk/app-debug.apk
            build/app/outputs/apk/debug/app-debug.apk
          retention-days: 30
          if-no-files-found: error

      - name: Build summary
        if: always()
        run: |
          echo "\n=== æ„å»ºæ‘˜è¦ ==="
          echo "Flutterç‰ˆæœ¬: $(flutter --version | head -1)"
          echo "Javaç‰ˆæœ¬: $(java -version 2>&1 | head -1)"
          echo "Gradleç‰ˆæœ¬: $(cd android && ./gradlew --version | grep Gradle || echo 'æœªçŸ¥')"
          
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ] || [ -f "build/app/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼APKå·²ä¸Šä¼ åˆ°GitHub Actions artifacts"
            echo "ğŸ“± ä¸‹è½½APK: åœ¨Actionsé¡µé¢ç‚¹å‡»æœ¬æ¬¡è¿è¡Œï¼Œç„¶åä¸‹è½½'my-app-debug-apk'æ–‡ä»¶"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
          fi