# 智能缓存清理功能说明

## 功能概述

为了解决用户反馈的"导入大量媒体数据后缓存空间异常膨胀"问题，我们实现了智能缓存清理功能。

## 问题分析

### 原有问题
1. **缓存暴涨**：每次导入大量媒体数据（如10GB）后，应用缓存空间会异常膨胀
2. **清理无效**：原有"清理空间"功能只能清理包含特定关键词的文件，无法覆盖所有大文件
3. **空间浪费**：缓存空间甚至超过实际数据区，导致总占用空间翻倍

### 根本原因
- 媒体导入流程会将文件完整复制到cache目录
- 视频缩略图生成时会在临时目录创建文件
- 这些文件没有自动过期或清理机制
- 实际大文件名多为hash/id/原名，不包含"import"等关键词

## 解决方案

### 智能清理逻辑
1. **递归扫描**：扫描整个cache目录，识别所有大于10MB的文件
2. **智能保护**：自动保护缩略图等必要缓存文件
3. **精准删除**：删除无用的大文件，释放存储空间

### 保护机制
以下文件类型会被自动保护，不会被删除：
- 缩略图文件（包含`thumbnail`、`thumb`、`_thumb_`等关键词）
- 视频缩略图（`video_thumb_`）
- 图片缩略图（`img_thumb_`）
- 音频波形缓存（`waveform`）
- OCR缓存（`ocr`）
- 其他必要缓存（`cache_`、`temp_thumb`）

### 清理策略
- **文件大小阈值**：默认10MB，可配置
- **递归扫描**：扫描所有子目录
- **安全删除**：只删除大文件，保留小文件和必要缓存
- **详细反馈**：提供删除文件列表和释放空间统计

## 功能特性

### 1. 手动清理
- **入口位置**：封面页设置弹窗 → "清理空间"
- **智能提示**：显示当前缓存信息和大文件统计
- **进度反馈**：清理过程中显示进度对话框
- **结果反馈**：清理完成后显示详细结果

### 2. 自动清理
- **触发时机**：媒体数据导入完成后自动触发
- **静默执行**：后台自动清理，不影响用户体验
- **日志记录**：在调试模式下记录清理结果

### 3. 缓存信息
- **实时统计**：显示缓存总大小、文件数量
- **大文件分析**：统计大于10MB的文件数量和总大小
- **文件列表**：列出所有大文件及其大小

## 使用方法

### 手动清理
1. 打开应用封面页
2. 点击右上角设置按钮
3. 选择"清理空间"选项
4. 查看缓存信息，点击"立即清理"
5. 等待清理完成，查看结果

### 自动清理
- 无需用户操作，导入媒体数据后自动执行
- 可在调试日志中查看清理结果

## 技术实现

### 核心方法
```dart
// 智能清理大缓存文件
Future<Map<String, dynamic>> cleanLargeCacheFiles({int maxSizeMB = 10})

// 获取缓存详细信息
Future<Map<String, dynamic>> getCacheInfo()
```

### 返回结果格式
```dart
{
  'success': true,
  'deletedCount': 5,
  'freedSizeMB': '125.3',
  'deletedFiles': ['file1.mp4 (25.1MB)', 'file2.mp4 (30.2MB)'],
  'protectedFiles': ['thumbnail1.jpg (15.0MB)']
}
```

## 安全保证

### 数据安全
- **绝不删除正式数据**：只清理cache目录，不影响用户媒体、文档、日记等
- **保护必要缓存**：自动识别并保护缩略图等有用缓存
- **错误处理**：完善的异常处理，清理失败不影响主功能

### 用户体验
- **无感知清理**：自动清理在后台执行，不影响正常使用
- **详细反馈**：提供清理前后的详细统计信息
- **可配置阈值**：可根据需要调整文件大小阈值

## 测试验证

### 测试脚本
运行 `test_cache_cleanup.dart` 可以测试清理功能：
```bash
dart test_cache_cleanup.dart
```

### 验证要点
1. 大文件被正确删除
2. 缩略图等必要文件被保护
3. 清理前后空间变化正确
4. 应用功能不受影响

## 注意事项

1. **首次使用**：建议在导入大量数据后立即使用清理功能
2. **定期清理**：可定期手动清理，保持应用空间清爽
3. **监控空间**：关注应用存储空间使用情况
4. **备份重要数据**：虽然功能安全，但建议定期备份重要数据

## 更新日志

- **v1.0**：实现基础智能清理功能
- **v1.1**：添加自动清理和缓存信息显示
- **v1.2**：优化保护机制和用户体验 